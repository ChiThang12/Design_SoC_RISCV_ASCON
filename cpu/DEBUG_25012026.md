OK, mÃ¬nh Ä‘á»c **toÃ n bá»™ core nÃ y** rá»“i.
DÆ°á»›i Ä‘Ã¢y lÃ  **DANH SÃCH SIGNAL Cáº¦N THEO DÃ•I Äá»‚ DEBUG**, Ä‘Æ°á»£c **lá»c Ä‘Ãºng theo kiáº¿n trÃºc + cÃ¡c FIX báº¡n Ä‘Ã£ lÃ m** (stall + snapshot + handshake).
ğŸ‘‰ KhÃ´ng thá»«a, khÃ´ng thiáº¿u.

---

# ğŸ¯ Má»¤C TIÃŠU DEBUG Cá»¦A CORE NÃ€Y

Core cá»§a báº¡n cÃ³ **3 vÃ¹ng dá»… lá»—i nháº¥t**:

1. **STALL / FREEZE pipeline**
2. **AXI-like handshake IMEM / DMEM**
3. **WB duplicate / sai rd / sai data**

ğŸ‘‰ VÃ¬ váº­y signals Ä‘Æ°á»£c chia **theo Ä‘Ãºng 3 vÃ¹ng nÃ y**.

---

# ğŸ§  NHÃ“M 1 â€” CORE CÃ“ CHáº Y HAY Äá»¨NG? (IF + PC)

### ğŸ”´ Báº®T BUá»˜C PHáº¢I THEO DÃ•I

```verilog
pc_if
pc_src_ex
target_pc_ex
stall
imem_ready
imem_valid
imem_addr
instr_if
```

### âœ… Ká»² Vá»ŒNG

* `stall = 0` & `imem_ready = 1` â†’ `pc_if` **tÄƒng / nháº£y**
* `stall = 1` â†’ `pc_if` **GIá»® NGUYÃŠN**
* `pc_src_ex = 1` â†’ `pc_if` = `target_pc_ex`

ğŸ“Œ **Náº¿u PC Ä‘á»©ng mÃ  imem_ready=1 â†’ BUG IFU / stall logic**

---

# ğŸ§  NHÃ“M 2 â€” PIPELINE CÃ“ Bá»Š TRÃ”I KHI STALL KHÃ”NG?

### ğŸ”´ RD + REGWRITE (Cá»°C Ká»² QUAN TRá»ŒNG)

Theo dÃµi **xuyÃªn pipeline**:

```verilog
rd_id
rd_ex
rd_mem
rd_wb

regwrite_id
regwrite_ex
regwrite_mem
regwrite_wb
```

### âœ… Ká»² Vá»ŒNG

* `stall = 1` â†’ **rd & regwrite KHÃ”NG Dá»ŠCH**
* `rd = 0` â†’ `regwrite_*` **PHáº¢I = 0**
* `store` â†’ `regwrite_mem = 0`

ğŸ“Œ **Báº¡n tá»«ng gáº·p lá»—i ghi x1/x2 sai â†’ nhÃ¬n nhÃ³m nÃ y lÃ  tháº¥y ngay**

---

# ğŸ§  NHÃ“M 3 â€” HAZARD + FLUSH CÃ“ ÄÃšNG KHÃ”NG?

```verilog
stall
flush_if_id
flush_id_ex
memread_ex
rs1_id
rs2_id
rd_ex
pc_src_ex
```

### âœ… Ká»² Vá»ŒNG

* Load-use hazard â†’ `stall=1`, `flush_id_ex=1`
* Branch/JAL/JALR â†’ `flush_if_id=1`, `flush_id_ex=1`
* KhÃ´ng Ä‘Æ°á»£c flush khi `stall` vÃ¬ memory

ğŸ“Œ Náº¿u:

* `flush_id_ex` xáº£y ra khi khÃ´ng branch â†’ âŒ
* `stall=1` nhÆ°ng `flush` váº«n báº­t â†’ âŒ

---

# ğŸ§  NHÃ“M 4 â€” EX STAGE (FORWARDING + BRANCH)

```verilog
rs1_ex
rs2_ex
forward_a
forward_b
alu_in1
alu_in2
alu_result_ex
branch_taken_ex
jump_ex
pc_plus_4_ex
```

### âœ… Ká»² Vá»ŒNG

* Forward Ä‘Ãºng khi `rd_mem == rs*_ex`
* Branch taken â†’ `pc_src_ex = 1`
* JAL/JALR â†’ WB = `pc_plus_4`

ğŸ“Œ Náº¿u branch nháº£y sai â†’ **so `alu_in1`, `alu_in2`, `imm_ex`**

---

# ğŸ§  NHÃ“M 5 â€” EX/MEM PIPELINE (VÃ™NG Dá»„ Lá»–I)

```verilog
stall
regwrite_ex_mem
memread_ex_mem
memwrite_ex_mem
memtoreg_ex_mem
rd_ex_mem
alu_result_ex_mem
write_data_ex_mem
```

### âœ… Ká»² Vá»ŒNG

* `stall=1` â†’ **control KHÃ”NG UPDATE**
* Data path **luÃ´n update** (theo FIX cá»§a báº¡n)

ğŸ“Œ Náº¿u:

* `stall=1` mÃ  `rd_ex_mem` Ä‘á»•i â†’ âŒ
* Store mÃ  `regwrite_ex_mem=1` â†’ âŒ

---

# ğŸ§  NHÃ“M 6 â€” DMEM HANDSHAKE (SIÃŠU QUAN TRá»ŒNG)

```verilog
dmem_valid
dmem_ready
dmem_we
dmem_addr
dmem_wdata
mem_req_pending
```

### âœ… Ká»² Vá»ŒNG

* `dmem_valid` **chá»‰ báº­t 1 láº§n / request**
* `mem_req_pending=1` â†’ `dmem_valid=0`
* `dmem_ready=1` â†’ pending set

ğŸ“Œ Náº¿u:

* `dmem_valid` báº­t nhiá»u chu ká»³ â†’ âŒ
* Store bá»‹ láº·p â†’ âŒ

---

# ğŸ§  NHÃ“M 7 â€” SNAPSHOT + WB (BUG CÅ¨ Cá»¦A Báº N)

```verilog
mem_req_pending
rd_mem_snapshot
regwrite_mem_snapshot
memtoreg_mem_snapshot
wb_done
```

### âœ… Ká»² Vá»ŒNG

* Snapshot **chá»‰ khi handshake**
* `wb_done` = 1 â†’ **chá»‰ ghi WB Ä‘Ãºng 1 láº§n**
* Sau WB â†’ snapshot khÃ´ng dÃ¹ng ná»¯a

ğŸ“Œ Náº¿u:

* `wb_done=0` mÃ  WB láº·p â†’ âŒ
* `rd_mem_snapshot` â‰  rd tháº­t â†’ âŒ

---

# ğŸ§  NHÃ“M 8 â€” MEM/WB PIPELINE

```verilog
regwrite_mem_wb
memtoreg_mem_wb
rd_mem_wb
alu_result_mem_wb
mem_data_mem_wb
pc_plus_4_mem_wb
```

### âœ… Ká»² Vá»ŒNG

* `stall=1` â†’ **GIá»® NGUYÃŠN**
* `load` â†’ data tá»« `mem_data_mem_wb`
* `jump` â†’ WB = `pc_plus_4_mem_wb`

---

# ğŸ§  NHÃ“M 9 â€” WB THá»°C Sá»° GHI GÃŒ?

```verilog
regwrite_wb
rd_wb
write_back_data_wb
```

### âœ… Ká»² Vá»ŒNG

* `regwrite_wb=1` â†’ rd â‰  0
* Má»—i instruction â†’ **ghi Ä‘Ãºng 1 láº§n**

ğŸ“Œ Náº¿u báº¡n tháº¥y:

```
WB: x1 <= ...
WB: x1 <= ...
```

â†’ nhÃ¬n snapshot + stall ngay

---

# ğŸ§¾ CHECKLIST DEBUG NGáº®N Gá»ŒN (IN LOG)

Náº¿u báº¡n muá»‘n **1 log duy nháº¥t / cycle**, in tháº¿ nÃ y lÃ  Ä‘á»§:

```
cycle pc stall
rd_id rd_ex rd_mem rd_wb
regwrite_ex regwrite_mem regwrite_wb
dmem_valid dmem_ready mem_req_pending
wb_done rd_mem_snapshot
write_back_data_wb
```

---

# ğŸ§  Káº¾T LUáº¬N

> **Báº¡n KHÃ”NG debug instruction â€” báº¡n debug FLOW**

Náº¿u 3 thá»© nÃ y Ä‘Ãºng:

1. `stall` freeze Ä‘Ãºng
2. `mem_req_pending` cháº·n Ä‘Ãºng
3. `wb_done` ghi Ä‘Ãºng 1 láº§n

ğŸ‘‰ Core nÃ y **CHáº Y ÄÃšNG**.

---

Náº¿u báº¡n muá»‘n, bÆ°á»›c tiáº¿p theo mÃ¬nh cÃ³ thá»ƒ:

* âœ… Viáº¿t **assert SystemVerilog** cho tá»«ng nhÃ³m
* ğŸ” Dá»±a trÃªn log cÅ© cá»§a báº¡n â†’ chá»‰ ra **CHÃNH DÃ’NG gÃ¢y bug**
* ğŸ“ˆ Váº½ timing diagram Ä‘Ãºng cho 1 `LW` + 1 `SW`

Báº¡n Ä‘ang Ä‘i ráº¥t Ä‘Ãºng hÆ°á»›ng rá»“i ğŸ’ª
